version: 2.1
jobs:
  build:
    docker:
      - image: docker:18.06.0-ce-git
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install dependencies
          command: |
            apk add --no-cache py-pip=10.0.1-r0
            pip install docker-compose==1.22.0
            mkdir -p /artifacts
      - restore_cache:
          keys:
            - v1-{{ .Branch }}
          paths:
            - /caches/docker.tar
      - run:
          name: Load Docker image layer cache
          command: |
            set +o pipefail
            docker load -i /caches/docker.tar | true
      - run:
          name: Build
          command: |
            VERSION=$(awk '/version/{gsub(/("|",)/,"",$2);print $2};' package.json)
            docker build --cache-from=docker -t pagespeedinsights-collector:${VERSION}-${CIRCLE_BUILD_NUM} .
      - run:
          name: Save Docker image layer cache
          command: |
            mkdir -p /caches
            docker save -o /caches/docker.tar pagespeedinsights-collector
      - save_cache:
          key: v1-{{ .Branch }}-{{ epoch }}
          paths:
            - /caches/docker.tar
      - run:
          name: Tests
          command: |
            docker run pagespeedinsights-collector:${CIRCLE_SHA1} npm run test:code
      - run:
          name: Report npm deps
          command: |
            docker run pagespeedinsights-collector:${CIRCLE_SHA1} npm outdated 2>&1 | tee /artifacts/npm-outdated.txt || true
      - run:
          name: Install trivy
          command: |
            apk add --update curl
            TRIVY_VERSION=$(
                curl --silent "https://api.github.com/repos/aquasecurity/trivy/releases/latest" | \
                grep '"tag_name":' | \
                sed -E 's/.*"v([^"]+)".*/\1/'
            )
            wget https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
            tar zxvf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz trivy
            mv trivy /usr/local/bin
      - run:
          name: Scan the local image with trivy
          command: |
            trivy --exit-code 0 --no-progress pagespeedinsights-collector:${CIRCLE_SHA1} | tee /artifacts/trivy-all.txt
            trivy --exit-code 0 --no-progress --ignore-unfixed pagespeedinsights-collector:${CIRCLE_SHA1} | tee /artifacts/trivy-fixable.txt
      - run:
          name: Push Docker image
          command: |
            if [ "${CIRCLE_BRANCH}" == "octopus" ]; then
              VERSION=$(awk '/version/{gsub(/("|",)/,"",$2);print $2};' package.json)
              docker tag pagespeedinsights-collector:${VERSION}-${CIRCLE_BUILD_NUM} ${DOCKER_REGISTRY}/${DOCKER_REGISTRY_SPACE}/pagespeedinsights-collector:${VERSION}-${CIRCLE_BUILD_NUM}
              docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD} ${DOCKER_REGISTRY}
              docker push ${DOCKER_REGISTRY}/${DOCKER_REGISTRY_SPACE}/pagespeedinsights-collector:${VERSION}-${CIRCLE_BUILD_NUM}
            fi
      - run:
          name: Create release in Octopus
          command: |
            if [ "${CIRCLE_BRANCH}" == "octopus" ]; then
              VERSION=$(awk '/version/{gsub(/("|",)/,"",$2);print $2};' package.json)
              docker run \
                pagespeedinsights-collector:${VERSION}-${CIRCLE_BUILD_NUM} \
                npx octopus-deploy release create \
                  --host ${OCTOPUS_SERVER_URL} \
                  --apiKey ${OCTOPUS_API_KEY} \
                  --projectSlugOrId pagespeedinsights-collector \
                  --releaseVersion ${VERSION}-${CIRCLE_BUILD_NUM} \
                  --packageVersion ${VERSION}-${CIRCLE_BUILD_NUM}
            fi
      - store_artifacts:
          path: /artifacts
