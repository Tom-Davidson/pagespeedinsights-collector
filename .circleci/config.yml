version: 2.1
jobs:
  build:
    docker:
      - image: docker:18.06.0-ce-git
    steps:
      - checkout
      - setup_remote_docker
#     - setup_remote_docker:
#         docker_layer_caching: true
      - run:
          name: Install dependencies
          command: |
            apk add --no-cache py-pip=10.0.1-r0
            pip install docker-compose==1.22.0
            mkdir -p /artifacts
      - run:
          name: Load Docker image layer cache
          command: |
            set +o pipefail
            docker load -i /caches/docker.tar | true
      - run:
          name: Build
          command: |
            VERSION=$(awk '/version/{gsub(/("|",)/,"",$2);print $2};' package.json)
            IMAGE_VERSION="${VERSION}-${CIRCLE_BUILD_NUM}"
            docker build --cache-from=docker -t pagespeedinsights-collector:${IMAGE_VERSION} .
      - run:
          name: Tests
          command: |
            VERSION=$(awk '/version/{gsub(/("|",)/,"",$2);print $2};' package.json)
            IMAGE_VERSION="${VERSION}-${CIRCLE_BUILD_NUM}"
            docker run pagespeedinsights-collector:${IMAGE_VERSION} npm run test:code
      - run:
          name: Report npm deps
          command: |
            VERSION=$(awk '/version/{gsub(/("|",)/,"",$2);print $2};' package.json)
            IMAGE_VERSION="${VERSION}-${CIRCLE_BUILD_NUM}"
            docker run pagespeedinsights-collector:${IMAGE_VERSION} npm outdated 2>&1 | tee /artifacts/npm-outdated.txt || true
      - run:
          name: Install trivy
          command: |
            apk add --update curl
            TRIVY_VERSION=$(
                curl --silent "https://api.github.com/repos/aquasecurity/trivy/releases/latest" | \
                grep '"tag_name":' | \
                sed -E 's/.*"v([^"]+)".*/\1/'
            )
            wget https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
            tar zxvf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz trivy
            mv trivy /usr/local/bin
      - run:
          name: Scan the local image with trivy
          command: |
            VERSION=$(awk '/version/{gsub(/("|",)/,"",$2);print $2};' package.json)
            IMAGE_VERSION="${VERSION}-${CIRCLE_BUILD_NUM}"
            trivy --exit-code 0 --no-progress pagespeedinsights-collector:${IMAGE_VERSION} | tee /artifacts/trivy-all.txt
            trivy --exit-code 0 --no-progress --ignore-unfixed pagespeedinsights-collector:${IMAGE_VERSION} | tee /artifacts/trivy-fixable.txt
      - run:
          name: Push Docker image
          command: |
            if [ "${CIRCLE_BRANCH}" == "octopus" ]; then
              VERSION=$(awk '/version/{gsub(/("|",)/,"",$2);print $2};' package.json)
              IMAGE_VERSION="${VERSION}-${CIRCLE_BUILD_NUM}"
              # GitHub Package Repo
              #docker tag pagespeedinsights-collector:${IMAGE_VERSION} ${DOCKER_REGISTRY}/${DOCKER_REGISTRY_SPACE}/pagespeedinsights-collector:${IMAGE_VERSION}
              #echo ${DOCKER_PASSWORD2} | docker login -u ${DOCKER_USERNAME} --password-stdin ${DOCKER_REGISTRY}
              #docker push ${DOCKER_REGISTRY}/${DOCKER_REGISTRY_SPACE}/pagespeedinsights-collector:${IMAGE_VERSION}
              # Docker Hub
              echo ${DOCKER_PASSWORD2} | docker login -u ${DOCKER_USERNAME2} --password-stdin
              docker tag pagespeedinsights-collector:${IMAGE_VERSION} ${DOCKER_REGISTRY_SPACE2}/pagespeedinsights-collector:${IMAGE_VERSION}
              docker push ${DOCKER_REGISTRY_SPACE2}/pagespeedinsights-collector:${IMAGE_VERSION}
            fi
      - run:
          name: Create release in Octopus
          command: |
            if [ "${CIRCLE_BRANCH}" == "octopus" ]; then
              VERSION=$(awk '/version/{gsub(/("|",)/,"",$2);print $2};' package.json)
              IMAGE_VERSION="${VERSION}-${CIRCLE_BUILD_NUM}"
              docker run \
                pagespeedinsights-collector:${IMAGE_VERSION} \
                npx octopus-deploy release create \
                  --host ${OCTOPUS_SERVER_URL} \
                  --apiKey ${OCTOPUS_API_KEY} \
                  --projectSlugOrId pagespeedinsights-collector \
                  --releaseVersion ${IMAGE_VERSION} \
                  --packageVersion ${IMAGE_VERSION}
            fi
      - store_artifacts:
          path: /artifacts
